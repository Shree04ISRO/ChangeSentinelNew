<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map - ChangeSentinel</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f172a;
            height: 100vh;
            overflow: hidden;
        }

        .navbar {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-name {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid #667eea;
            backdrop-filter: blur(10px);
        }

        .map-container {
            display: flex;
            height: calc(100vh - 70px);
        }

        .sidebar-panel {
            width: 380px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            box-shadow: 4px 0 30px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            z-index: 500;
            border-right: 2px solid rgba(102, 126, 234, 0.3);
        }

        .sidebar-panel::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar-panel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .sidebar-panel::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }

        .panel-section {
            padding: 25px;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .tool-btn {
            padding: 18px;
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            color: white;
        }

        .tool-btn:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .tool-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.6);
        }

        .tool-icon {
            font-size: 2.2rem;
            margin-bottom: 8px;
        }

        .tool-label {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .layer-control {
            margin-bottom: 15px;
        }

        .layer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .layer-item:hover {
            background: rgba(102, 126, 234, 0.15);
            transform: translateX(5px);
        }

        .layer-item.active {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }

        .layer-info {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }

        .layer-icon {
            font-size: 1.5rem;
        }

        .layer-name {
            font-weight: 600;
        }

        .toggle-switch {
            position: relative;
            width: 54px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        input:checked + .toggle-slider {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .info-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            backdrop-filter: blur(10px);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .info-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .info-text {
            font-size: 0.9rem;
            opacity: 0.9;
            line-height: 1.5;
        }

        .coord-display {
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: white;
            margin-bottom: 12px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
            color: white;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .stat-value {
            font-weight: 700;
            color: #667eea;
            font-size: 1.1rem;
        }

        #map {
            flex: 1;
            height: 100%;
            filter: brightness(1.1) contrast(1.1);
        }

        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .control-btn {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(102, 126, 234, 0.5);
            padding: 14px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.3rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            color: white;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            border-color: #667eea;
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
        }

        .search-box {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            width: 350px;
        }

        .search-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid rgba(102, 126, 234, 0.5);
            border-radius: 12px;
            font-size: 1rem;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            color: white;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }

        .notification {
            position: fixed;
            top: 90px;
            right: 20px;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            padding: 20px 24px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            z-index: 2000;
            max-width: 380px;
            display: none;
            animation: slideIn 0.4s ease;
            border: 2px solid rgba(102, 126, 234, 0.3);
            color: white;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            border-left: 4px solid #10b981;
        }

        .notification.info {
            border-left: 4px solid #3b82f6;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(102, 126, 234, 0.2);
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .save-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .save-modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(102, 126, 234, 0.3);
            color: white;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .modal-subtitle {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: white;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            background: rgba(102, 126, 234, 0.1);
            color: white;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .modal-buttons .btn {
            flex: 1;
        }

        @media (max-width: 968px) {
            .sidebar-panel {
                position: absolute;
                left: -380px;
                height: 100%;
                transition: left 0.3s ease;
            }
            .sidebar-panel.open {
                left: 0;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo-section">
            <span style="font-size: 1.8rem;">üõ∞Ô∏è</span>
            <span class="brand-name">ChangeSentinel</span>
        </div>
        <div class="nav-actions">
            <button class="btn btn-secondary" onclick="openSaveModal()">üíæ Save AOI</button>
            <a href="dashboard.html" class="btn">‚Üê Back to Dashboard</a>
        </div>
    </nav>

    <div class="map-container">
        <aside class="sidebar-panel">
            <div class="panel-section">
                <h2 class="panel-title">üó∫Ô∏è Drawing Tools</h2>
                <div class="tool-grid">
                    <div class="tool-btn" onclick="activateTool('polygon')">
                        <div class="tool-icon">‚¨°</div>
                        <div class="tool-label">Polygon</div>
                    </div>
                    <div class="tool-btn" onclick="activateTool('rectangle')">
                        <div class="tool-icon">‚ñ≠</div>
                        <div class="tool-label">Rectangle</div>
                    </div>
                    <div class="tool-btn" onclick="activateTool('circle')">
                        <div class="tool-icon">‚óØ</div>
                        <div class="tool-label">Circle</div>
                    </div>
                    <div class="tool-btn" onclick="activateTool('marker')">
                        <div class="tool-icon">üìç</div>
                        <div class="tool-label">Marker</div>
                    </div>
                </div>
                <button class="btn" style="width: 100%; margin-bottom: 10px;" onclick="clearAll()">üóëÔ∏è Clear All</button>
            </div>

            <div class="panel-section">
                <h2 class="panel-title">üõ∞Ô∏è Satellite Layers</h2>
                <div class="layer-control">
                    <div class="layer-item active" onclick="switchLayer('satellite')">
                        <div class="layer-info">
                            <span class="layer-icon">üõ∞Ô∏è</span>
                            <span class="layer-name">Satellite View</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked id="satelliteToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="layer-item" onclick="switchLayer('street')">
                        <div class="layer-info">
                            <span class="layer-icon">üó∫Ô∏è</span>
                            <span class="layer-name">Street Map</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="streetToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="layer-item" onclick="switchLayer('terrain')">
                        <div class="layer-info">
                            <span class="layer-icon">‚õ∞Ô∏è</span>
                            <span class="layer-name">Terrain</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="terrainToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <h2 class="panel-title">üìä Area Statistics</h2>
                <div class="stat-row">
                    <span class="stat-label">Drawn Areas</span>
                    <span class="stat-value" id="areaCount">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Area</span>
                    <span class="stat-value" id="totalArea">0 km¬≤</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Active Layer</span>
                    <span class="stat-value" id="activeLayer">Satellite</span>
                </div>
            </div>

            <div class="panel-section">
                <h2 class="panel-title">üìç Current Position</h2>
                <div class="coord-display" id="coordDisplay">
                    Lat: 13.0827¬∞ N<br>
                    Lng: 80.2707¬∞ E<br>
                    Zoom: 10
                </div>
                <button class="btn" style="width: 100%;" onclick="getCurrentLocation()">
                    üìç Use My Location
                </button>
            </div>

            <div class="panel-section">
                <div class="info-card">
                    <div class="info-title">üí° Quick Tip</div>
                    <div class="info-text">Draw areas on the map and save them as AOIs for monitoring environmental changes. Your saved areas will appear in the dashboard!</div>
                </div>
            </div>
        </aside>

        <div style="flex: 1; position: center;">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="üîç Search location (e.g., Chennai, India)">
            </div>

            <div class="map-controls">
                <button class="control-btn" onclick="map.zoomIn()" title="Zoom In">‚ûï</button>
                <button class="control-btn" onclick="map.zoomOut()" title="Zoom Out">‚ûñ</button>
                <button class="control-btn" onclick="map.setView([13.0827, 80.2707], 10)" title="Reset View">üéØ</button>
                <button class="control-btn" onclick="toggleFullscreen()" title="Fullscreen">‚õ∂</button>
            </div>

            <div id="map"></div>

            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <div id="notificationContent"></div>
    </div>

    <div class="save-modal" id="saveModal">
        <div class="modal-content">
            <h2 class="modal-title">üíæ Save Area of Interest</h2>
            <p class="modal-subtitle">Give your AOI a name and description</p>
            <div class="form-group">
                <label for="aoiName">AOI Name *</label>
                <input type="text" id="aoiName" placeholder="e.g., Forest Area - Chennai" required>
            </div>
            <div class="form-group">
                <label for="aoiDescription">Description</label>
                <textarea id="aoiDescription" rows="3" placeholder="Brief description of this area..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeSaveModal()">Cancel</button>
                <button class="btn" onclick="saveAOI()">Save AOI</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script>
        // Initialize IndexedDB
        let db;
        const DB_NAME = 'ChangeSentinelDB';

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('aois')) {
                        const aoiStore = db.createObjectStore('aois', { keyPath: 'id', autoIncrement: true });
                        aoiStore.createIndex('userId', 'userId', { unique: false });
                    }
                };
            });
        }

        // Initialize map
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false
        }).setView([13.0827, 80.2707], 10);

        // Satellite layer
        const satelliteLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20
        }).addTo(map);

        // Street layer
        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        });

        // Terrain layer
        const terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            maxZoom: 17
        });

        let drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        // Drawing controls
        const drawControl = new L.Control.Draw({
            draw: {
                polygon: {
                    shapeOptions: {
                        color: '#667eea',
                        weight: 3,
                        fillOpacity: 0.3
                    }
                },
                rectangle: {
                    shapeOptions: {
                        color: '#667eea',
                        weight: 3,
                        fillOpacity: 0.3
                    }
                },
                circle: {
                    shapeOptions: {
                        color: '#667eea',
                        weight: 3,
                        fillOpacity: 0.3
                    }
                },
                marker: true,
                polyline: false,
                circlemarker: false
            },
            edit: {
                featureGroup: drawnItems,
                remove: true
            }
        });
        map.addControl(drawControl);

        // Handle drawing
        map.on('draw:created', function(e) {
            const layer = e.layer;
            drawnItems.addLayer(layer);
            updateStats();
            showNotification('Area created! Click "Save AOI" to store it.', 'success');
            
            if (e.layerType === 'polygon' || e.layerType === 'rectangle') {
                const area = (L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]) / 1000000).toFixed(2);
                layer.bindPopup(`Area: ${area} km¬≤`).openPopup();
            }
        });

        map.on('draw:deleted', function() {
            updateStats();
            showNotification('Area deleted', 'info');
        });

        map.on('mousemove', function(e) {
            const lat = e.latlng.lat.toFixed(4);
            const lng = e.latlng.lng.toFixed(4);
            const zoom = map.getZoom();
            document.getElementById('coordDisplay').innerHTML = `
                Lat: ${lat}¬∞<br>
                Lng: ${lng}¬∞<br>
                Zoom: ${zoom}
            `;
        });

        function switchLayer(layerType) {
            map.eachLayer(function(layer) {
                if (layer instanceof L.TileLayer) {
                    map.removeLayer(layer);
                }
            });

            document.querySelectorAll('.layer-item').forEach(item => {
                item.classList.remove('active');
            });

            if (layerType === 'satellite') {
                satelliteLayer.addTo(map);
                document.querySelector('[onclick="switchLayer(\'satellite\')"]').classList.add('active');
                document.getElementById('activeLayer').textContent = 'Satellite';
            } else if (layerType === 'street') {
                streetLayer.addTo(map);
                document.querySelector('[onclick="switchLayer(\'street\')"]').classList.add('active');
                document.getElementById('activeLayer').textContent = 'Street';
            } else if (layerType === 'terrain') {
                terrainLayer.addTo(map);
                document.querySelector('[onclick="switchLayer(\'terrain\')"]').classList.add('active');
                document.getElementById('activeLayer').textContent = 'Terrain';
            }

            map.addLayer(drawnItems);
        }

        function activateTool(tool) {
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            const handlers = {
                'polygon': new L.Draw.Polygon(map),
                'rectangle': new L.Draw.Rectangle(map),
                'circle': new L.Draw.Circle(map),
                'marker': new L.Draw.Marker(map)
            };
            
            if (handlers[tool]) {
                handlers[tool].enable();
            }
        }

        function clearAll() {
            if (confirm('Are you sure you want to clear all drawings?')) {
                drawnItems.clearLayers();
                updateStats();
                showNotification('All areas cleared', 'info');
            }
        }

        function updateStats() {
            let count = 0;
            let totalArea = 0;
            
            drawnItems.eachLayer(function(layer) {
                count++;
                if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
                    totalArea += L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]) / 1000000;
                } else if (layer instanceof L.Circle) {
                    totalArea += Math.PI * Math.pow(layer.getRadius() / 1000, 2);
                }
            });
            
            document.getElementById('areaCount').textContent = count;
            document.getElementById('totalArea').textContent = totalArea.toFixed(2) + ' km¬≤';
        }

        function getCurrentLocation() {
            showLoading();
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        map.setView([lat, lng], 13);
                        L.marker([lat, lng]).addTo(map)
                            .bindPopup('Your Location')
                            .openPopup();
                        hideLoading();
                        showNotification('Location found!', 'success');
                    },
                    function() {
                        hideLoading();
                        showNotification('Unable to get location', 'info');
                    }
                );
            } else {
                hideLoading();
                showNotification('Geolocation not supported', 'info');
            }
        }

        document.getElementById('searchInput').addEventListener('keypress', async function(e) {
            if (e.key === 'Enter') {
                const query = this.value;
                if (query) {
                    showLoading();
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                        const data = await response.json();
                        
                        if (data && data.length > 0) {
                            const lat = parseFloat(data[0].lat);
                            const lon = parseFloat(data[0].lon);
                            map.setView([lat, lon], 13);
                            L.marker([lat, lon]).addTo(map)
                                .bindPopup(data[0].display_name)
                                .openPopup();
                            showNotification('Location found!', 'success');
                        } else {
                            showNotification('Location not found', 'info');
                        }
                    } catch (error) {
                        showNotification('Search failed', 'info');
                    }
                    hideLoading();
                }
            }
        });

        function openSaveModal() {
            const areaCount = document.getElementById('areaCount').textContent;
            if (areaCount === '0') {
                showNotification('Please draw an area first!', 'info');
                return;
            }
            document.getElementById('saveModal').classList.add('show');
        }

        function closeSaveModal() {
            document.getElementById('saveModal').classList.remove('show');
            document.getElementById('aoiName').value = '';
            document.getElementById('aoiDescription').value = '';
        }

        async function saveAOI() {
            const name = document.getElementById('aoiName').value.trim();
            if (!name) {
                showNotification('Please enter an AOI name', 'info');
                return;
            }

            const description = document.getElementById('aoiDescription').value.trim();
            const sessionData = sessionStorage.getItem('loggedInUser');
            
            if (!sessionData) {
                showNotification('Please login first', 'info');
                window.location.href = 'login.html';
                return;
            }

            const user = JSON.parse(sessionData);
            
            // Collect all drawn shapes
            const shapes = [];
            let totalArea = 0;
            
            drawnItems.eachLayer(function(layer) {
                let shapeData = {
                    type: layer instanceof L.Marker ? 'marker' : 
                          layer instanceof L.Circle ? 'circle' : 
                          layer instanceof L.Rectangle ? 'rectangle' : 'polygon',
                    latlngs: null,
                    center: null,
                    radius: null
                };

                if (layer instanceof L.Marker) {
                    shapeData.center = layer.getLatLng();
                } else if (layer instanceof L.Circle) {
                    shapeData.center = layer.getLatLng();
                    shapeData.radius = layer.getRadius();
                    totalArea += Math.PI * Math.pow(layer.getRadius() / 1000, 2);
                } else {
                    shapeData.latlngs = layer.getLatLngs();
                    if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
                        totalArea += L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]) / 1000000;
                    }
                }

                shapes.push(shapeData);
            });

            const aoiData = {
                userId: user.id,
                name: name,
                description: description,
                shapes: shapes,
                area: totalArea.toFixed(2),
                center: map.getCenter(),
                zoom: map.getZoom(),
                createdAt: new Date().toISOString(),
                detections: 0,
                alerts: 0,
                status: 'active'
            };

            try {
                const transaction = db.transaction(['aois'], 'readwrite');
                const store = transaction.objectStore('aois');
                
                await new Promise((resolve, reject) => {
                    const request = store.add(aoiData);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                showNotification('AOI saved successfully! ‚úÖ', 'success');
                closeSaveModal();
                
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
            } catch (error) {
                console.error('Save error:', error);
                showNotification('Failed to save AOI. Please try again.', 'info');
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.className = `notification ${type} show`;
            document.getElementById('notificationContent').textContent = message;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        // Initialize
        initDB().then(() => {
            updateStats();
            console.log('Database initialized');
        }).catch(error => {
            console.error('Database initialization failed:', error);
        });
function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 2);
        request.onsuccess = () => { db = request.result; resolve(db); };
    });
}
    </script>
</body>
</html>