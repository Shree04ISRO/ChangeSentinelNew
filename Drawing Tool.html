<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map - ChangeSentinel</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f3f4f6;
            height: 100vh;
            overflow: hidden;
        }

        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .nav-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .map-container {
            display: flex;
            height: calc(100vh - 70px);
        }

        .sidebar-panel {
            width: 350px;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            z-index: 500;
        }

        .panel-section {
            padding: 25px;
            border-bottom: 1px solid #e5e7eb;
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #374151;
            margin-bottom: 15px;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .tool-btn {
            padding: 15px;
            background: linear-gradient(135deg, #f9fafb, #ffffff);
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .tool-btn:hover, .tool-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
        }

        .tool-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .tool-label {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .layer-control {
            margin-bottom: 15px;
        }

        .layer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .layer-item:hover {
            background: #f3f4f6;
        }

        .layer-item.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 2px solid #667eea;
        }

        .layer-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .layer-icon {
            font-size: 1.5rem;
        }

        .layer-name {
            font-weight: 600;
            color: #374151;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .info-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .info-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .info-text {
            font-size: 0.9rem;
            opacity: 0.95;
        }

        .coord-display {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #374151;
            margin-bottom: 10px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .stat-value {
            font-weight: 600;
            color: #374151;
        }

        #map {
            flex: 1;
            height: 100%;
        }

        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-btn {
            background: white;
            border: 2px solid #e5e7eb;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .control-btn:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .search-box {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.95rem;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .notification {
            position: fixed;
            top: 90px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            max-width: 350px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            border-left: 4px solid #10b981;
        }

        .notification.info {
            border-left: 4px solid #3b82f6;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 968px) {
            .sidebar-panel {
                position: absolute;
                left: -350px;
                height: 100%;
                transition: left 0.3s ease;
            }
            .sidebar-panel.open {
                left: 0;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo-section">
            <span style="font-size: 1.8rem;">üõ∞Ô∏è</span>
            <span class="brand-name">ChangeSentinel</span>
        </div>
        <div class="nav-actions">
            <button class="btn btn-secondary" onclick="saveCurrent()">üíæ Save AOI</button>
            <a href="dashboard.html" class="btn">‚Üê Back to Dashboard</a>
        </div>
    </nav>

    <div class="map-container">
        <aside class="sidebar-panel">
            <div class="panel-section">
                <h2 class="panel-title">üó∫Ô∏è Drawing Tools</h2>
                <div class="tool-grid">
                    <div class="tool-btn" onclick="activateTool('polygon')">
                        <div class="tool-icon">‚¨°</div>
                        <div class="tool-label">Polygon</div>
                    </div>
                    <div class="tool-btn" onclick="activateTool('rectangle')">
                        <div class="tool-icon">‚ñ≠</div>
                        <div class="tool-label">Rectangle</div>
                    </div>
                    <div class="tool-btn" onclick="activateTool('circle')">
                        <div class="tool-icon">‚óã</div>
                        <div class="tool-label">Circle</div>
                    </div>
                    <div class="tool-btn" onclick="activateTool('marker')">
                        <div class="tool-icon">üìç</div>
                        <div class="tool-label">Marker</div>
                    </div>
                </div>
                <button class="btn" style="width: 100%; margin-bottom: 10px;" onclick="clearAll()">üóëÔ∏è Clear All</button>
            </div>

            <div class="panel-section">
                <h2 class="panel-title">üõ∞Ô∏è Satellite Layers</h2>
                <div class="layer-control">
                    <div class="layer-item active" onclick="switchLayer('satellite')">
                        <div class="layer-info">
                            <span class="layer-icon">üõ∞Ô∏è</span>
                            <span class="layer-name">Satellite View</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked id="satelliteToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="layer-item" onclick="switchLayer('street')">
                        <div class="layer-info">
                            <span class="layer-icon">üó∫Ô∏è</span>
                            <span class="layer-name">Street Map</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="streetToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="layer-item" onclick="switchLayer('terrain')">
                        <div class="layer-info">
                            <span class="layer-icon">‚õ∞Ô∏è</span>
                            <span class="layer-name">Terrain</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="terrainToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <h2 class="panel-title">üìä Area Statistics</h2>
                <div class="stat-row">
                    <span class="stat-label">Drawn Areas</span>
                    <span class="stat-value" id="areaCount">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Area</span>
                    <span class="stat-value" id="totalArea">0 km¬≤</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Active Layer</span>
                    <span class="stat-value" id="activeLayer">Satellite</span>
                </div>
            </div>

            <div class="panel-section">
                <h2 class="panel-title">üìç Current Position</h2>
                <div class="coord-display" id="coordDisplay">
                    Lat: 13.0827¬∞ N<br>
                    Lng: 80.2707¬∞ E<br>
                    Zoom: 10
                </div>
                <button class="btn" style="width: 100%;" onclick="getCurrentLocation()">
                    üìç Use My Location
                </button>
            </div>

            <div class="panel-section">
                <div class="info-card">
                    <div class="info-title">üí° Quick Tip</div>
                    <div class="info-text">Click drawing tools above to create areas of interest. Use satellite layers to see real-time Earth imagery!</div>
                </div>
            </div>
        </aside>

        <div style="flex: 1; position: relative;">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="üîç Search location (e.g., Chennai, India)">
            </div>

            <div class="map-controls">
                <button class="control-btn" onclick="map.zoomIn()" title="Zoom In">‚ûï</button>
                <button class="control-btn" onclick="map.zoomOut()" title="Zoom Out">‚ûñ</button>
                <button class="control-btn" onclick="map.setView([13.0827, 80.2707], 10)" title="Reset View">üéØ</button>
                <button class="control-btn" onclick="toggleFullscreen()" title="Fullscreen">‚õ∂</button>
            </div>

            <div id="map"></div>

            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <div id="notificationContent"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script>
        // Initialize map with satellite view (Chennai, India as default)
        const map = L.map('map').setView([13.0827, 80.2707], 10);

        // Satellite layer (Google Satellite)
        const satelliteLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            attribution: 'Satellite imagery'
        }).addTo(map);

        // Street layer (OpenStreetMap)
        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        });

        // Terrain layer
        const terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            maxZoom: 17,
            attribution: '¬© OpenTopoMap'
        });

        let currentLayer = 'satellite';
        let drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        // Drawing controls
        const drawControl = new L.Control.Draw({
            draw: {
                polygon: {
                    shapeOptions: {
                        color: '#667eea',
                        weight: 3
                    }
                },
                rectangle: {
                    shapeOptions: {
                        color: '#667eea',
                        weight: 3
                    }
                },
                circle: {
                    shapeOptions: {
                        color: '#667eea',
                        weight: 3
                    }
                },
                marker: true,
                polyline: false,
                circlemarker: false
            },
            edit: {
                featureGroup: drawnItems,
                remove: true
            }
        });
        map.addControl(drawControl);

        // Handle drawing
        map.on('draw:created', function(e) {
            const layer = e.layer;
            drawnItems.addLayer(layer);
            updateStats();
            showNotification('Area created successfully!', 'success');
            
            // Add popup with area info
            if (e.layerType === 'polygon' || e.layerType === 'rectangle') {
                const area = (L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]) / 1000000).toFixed(2);
                layer.bindPopup(`Area: ${area} km¬≤`).openPopup();
            }
        });

        map.on('draw:deleted', function() {
            updateStats();
            showNotification('Area deleted', 'info');
        });

        // Update coordinates on mouse move
        map.on('mousemove', function(e) {
            const lat = e.latlng.lat.toFixed(4);
            const lng = e.latlng.lng.toFixed(4);
            const zoom = map.getZoom();
            document.getElementById('coordDisplay').innerHTML = `
                Lat: ${lat}¬∞<br>
                Lng: ${lng}¬∞<br>
                Zoom: ${zoom}
            `;
        });

        // Layer switching
        function switchLayer(layerType) {
            map.eachLayer(function(layer) {
                if (layer instanceof L.TileLayer) {
                    map.removeLayer(layer);
                }
            });

            document.querySelectorAll('.layer-item').forEach(item => {
                item.classList.remove('active');
            });

            if (layerType === 'satellite') {
                satelliteLayer.addTo(map);
                document.querySelector('[onclick="switchLayer(\'satellite\')"]').classList.add('active');
                document.getElementById('activeLayer').textContent = 'Satellite';
            } else if (layerType === 'street') {
                streetLayer.addTo(map);
                document.querySelector('[onclick="switchLayer(\'street\')"]').classList.add('active');
                document.getElementById('activeLayer').textContent = 'Street';
            } else if (layerType === 'terrain') {
                terrainLayer.addTo(map);
                document.querySelector('[onclick="switchLayer(\'terrain\')"]').classList.add('active');
                document.getElementById('activeLayer').textContent = 'Terrain';
            }

            map.addLayer(drawnItems);
        }

        // Tool activation
        function activateTool(tool) {
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            const handlers = {
                'polygon': new L.Draw.Polygon(map),
                'rectangle': new L.Draw.Rectangle(map),
                'circle': new L.Draw.Circle(map),
                'marker': new L.Draw.Marker(map)
            };
            
            if (handlers[tool]) {
                handlers[tool].enable();
            }
        }

        // Clear all drawings
        function clearAll() {
            if (confirm('Are you sure you want to clear all drawings?')) {
                drawnItems.clearLayers();
                updateStats();
                showNotification('All areas cleared', 'info');
            }
        }

        // Update statistics
        function updateStats() {
            let count = 0;
            let totalArea = 0;
            
            drawnItems.eachLayer(function(layer) {
                count++;
                if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
                    totalArea += L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]) / 1000000;
                } else if (layer instanceof L.Circle) {
                    totalArea += Math.PI * Math.pow(layer.getRadius() / 1000, 2);
                }
            });
            
            document.getElementById('areaCount').textContent = count;
            document.getElementById('totalArea').textContent = totalArea.toFixed(2) + ' km¬≤';
        }

        // Get current location
        function getCurrentLocation() {
            showLoading();
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        map.setView([lat, lng], 13);
                        L.marker([lat, lng]).addTo(map)
                            .bindPopup('Your Location')
                            .openPopup();
                        hideLoading();
                        showNotification('Location found!', 'success');
                    },
                    function() {
                        hideLoading();
                        showNotification('Unable to get location', 'info');
                    }
                );
            } else {
                hideLoading();
                showNotification('Geolocation not supported', 'info');
            }
        }

        // Search location
        document.getElementById('searchInput').addEventListener('keypress', async function(e) {
            if (e.key === 'Enter') {
                const query = this.value;
                if (query) {
                    showLoading();
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                        const data = await response.json();
                        
                        if (data && data.length > 0) {
                            const lat = parseFloat(data[0].lat);
                            const lon = parseFloat(data[0].lon);
                            map.setView([lat, lon], 13);
                            L.marker([lat, lon]).addTo(map)
                                .bindPopup(data[0].display_name)
                                .openPopup();
                            showNotification('Location found!', 'success');
                        } else {
                            showNotification('Location not found', 'info');
                        }
                    } catch (error) {
                        showNotification('Search failed', 'info');
                    }
                    hideLoading();
                }
            }
        });

        // Save current AOI
        function saveCurrent() {
            const areaCount = document.getElementById('areaCount').textContent;
            if (areaCount === '0') {
                showNotification('Please draw an area first', 'info');
                return;
            }
            
            // Here you would save to IndexedDB
            showNotification('Area saved successfully!', 'success');
        }

        // Fullscreen toggle
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Notification system
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.className = `notification ${type} show`;
            document.getElementById('notificationContent').textContent = message;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        // Initialize
        updateStats();
    </script>
</body>
</html>